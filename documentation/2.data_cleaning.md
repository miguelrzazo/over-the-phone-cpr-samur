
# Documentación del Proceso de Limpieza de Datos
# RCP Transtelefónica - Proyecto de Investigación

## 1. Visión General del Proceso de Limpieza

El proceso de limpieza de datos implementado en `cleandata_simplified.py` aplica una serie de transformaciones y criterios de exclusión para preparar los datos para el análisis estadístico, asegurando que cumplen con los requisitos del estudio sobre RCP transtelefónica.

### 1.1 Objetivos de la Limpieza de Datos

- **Uniformizar formatos**: Convertir variables a formatos consistentes
- **Eliminar inconsistencias**: Corregir valores incoherentes o imposibles
- **Aplicar criterios de exclusión**: Implementar criterios para excluir casos no relevantes
- **Generar variables derivadas**: Calcular variables necesarias para el análisis
- **Preservar información clave**: Mantener los casos con RCP transtelefónica

### 1.2 Verificación Manual de los Datos

**Importante**: Todos los datos procesados fueron posteriormente verificados manualmente por el equipo investigador para garantizar la calidad y precisión de la información. Esta verificación incluyó:

- **Confirmación de casos de RCP transtelefónica**: Revisión individual de cada caso identificado como RCP transtelefónica
- **Validación de exclusiones**: Comprobación de que los casos excluidos cumplían estrictamente los criterios establecidos
- **Verificación de outcomes**: Contraste de los resultados de ROSC, supervivencia y CPC con los registros clínicos originales
- **Control de anomalías**: Identificación y corrección de valores atípicos o incongruentes

Esta doble verificación (automática + manual) asegura la máxima fiabilidad de los datos utilizados para el análisis estadístico.

## 2. Pipeline de Limpieza de Datos

### 2.1 Lectura y Preprocesamiento Inicial

1. **Lectura de datos brutos**: Los datos se importan del archivo CSV original
2. **Renombrado de columnas**: Se aplica un esquema estandarizado de nombres para todas las columnas
3. **Unión SVB-SVA**: Se fusionan datos de unidades básicas y avanzadas para preservar casos de RCP transtelefónica

### 2.2 Transformaciones Principales

1. **Columnas booleanas**: Conversión a valores binarios (0/1)
   - `rcp_transtelefonica`: 1 si es verdadero, 0 si es falso
   - `desa_externo`: 1 si se utilizó desfibrilador externo, 0 si no
   - `rcp_testigos`: 1 si hubo RCP por testigos, 0 si no

2. **Variables temporales**:
   - `tiempo_llegada_unidad`: Suma de `tiempo_co + tiempo_c3 + tiempo_c2_c3`
   - `tiempo_rcp`: Duración de la RCP en segundos

3. **Procesamiento de ritmos cardíacos**:
   - Ritmos desfibrilables = 1: VF, TV, FV, Fibrilación, Taquicardia ventricular
   - Otros ritmos = 0

4. **Clasificación de respondientes**:
   - `policia`: Detectado por menciones en texto a "policia", "municipal", códigos "091", etc.
   - `bombero`: Detectado por menciones a "bombero", "080", "beta", etc.
   - `sanitario`: Incluye SAMUR SVB, SUMMA, TES, personal de hospital
   - `legos`: Ciudadanos sin formación sanitaria especializada

5. **Determinación de ROSC**:
   - Por menciones explícitas de "rosc" o "recuperada"
   - Si el tiempo de RCP (`tiempo_c3_c4`) es mayor que 0

6. **Cálculo del tiempo de RCP**:
   - Extracción de tiempo mencionado en texto (patrones como "RCP durante X min")
   - Cálculo basado en horas de inicio y finalización cuando están disponibles

7. **Determinación de supervivencia y CPC**:
   - Supervivencia basada en seguimiento hospitalario
   - CPC (Cerebral Performance Category) basado en menciones explícitas o inferido

## 3. Reglas de Exclusión Aplicadas

### 3.1 Exclusiones por Tipo de Caso

1. **Casos traumáticos**: Se excluyen casos donde la parada cardiorrespiratoria tiene origen traumático.
   - **Palabras clave de exclusión**: 
     - `trauma`, `traumatico`, `herida`, `heridas`, `herido`, `heridos`
     - `caida`, `caidas`, `accidente`, `precipitado`, `ahogamiento`
     - `suicidio`, `golpe`, `golpes`, `agresion`, `agresión`
     - `intoxicacion`, `intoxicación`, `sobredosis`, `electrocucion`, `electrocución`
     - `lesion`, `lesiones`, `lesión`, `lesiónes`, `incendio`, `atropello`
   - **Método de detección**: Búsqueda de palabras clave en todos los campos de texto del registro
   - **Porcentaje excluido**: 8.1% del total (49/603 casos)
   - **Justificación**: El estudio se centra en paradas cardiorrespiratorias de origen médico/cardiaco, donde la RCP transtelefónica tiene mayor relevancia clínica. Las PCR traumáticas tienen fisiopatología y respuesta a RCP diferentes.

2. **Casos sin información de seguimiento**:
   - Se consideran sin información de seguimiento aquellos que no tienen datos en columnas de seguimiento (`6 horas`, `24 horas`, `7 dias`) ni indicadores de resultado en otras columnas.
   - Justificación: Sin información de seguimiento es imposible determinar los outcomes primarios del estudio (supervivencia, CPC).

### 3.2 Criterios de Inclusión para Outcomes

1. **ROSC (Retorno de Circulación Espontánea)**:
   - Se considera positivo (1) si:
     - Hay mención explícita a "ROSC" o "recuperada" en los campos de texto
     - El tiempo de RCP (`tiempo_c3_c4`) es mayor que 0
   - Justificación: El ROSC es un indicador de éxito inicial de la reanimación y punto crítico para la supervivencia.

2. **Supervivencia a 7 días**:
   - Se considera positiva (1) si:
     - Hay ROSC documentado
     - No hay indicadores de muerte en el seguimiento
     - Hay indicadores positivos de supervivencia (alta, estable, etc.)
   - Se considera negativa (0) si:
     - No hay ROSC documentado
     - Hay indicadores de muerte en el seguimiento
     - No hay información de seguimiento
   - Justificación: Enfoque conservador que evita sobreestimar la supervivencia.

3. **CPC (Cerebral Performance Category)**:
   - Se asigna valor explícito (1-5) si está documentado en texto
   - Se asigna CPC 5 si:
     - No hay ROSC
     - No hay supervivencia a 7 días
     - No hay información explícita de CPC
   - Justificación: El CPC 5 representa muerte cerebral o muerte, siendo el peor pronóstico neurológico.

### 3.3 Tratamiento de Datos Faltantes

1. **Campos temporales**:
   - Valores faltantes o no numéricos se convierten a 0
   - Justificación: Enfoque conservador que evita excluir casos por falta de datos temporales.

2. **Variables booleanas**:
   - Solo valores explícitamente "verdadero", "true" o "1" se convierten a 1
   - Todo lo demás se convierte a 0
   - Justificación: Minimizar falsos positivos en variables críticas.

3. **Identificación de RCP transtelefónica**:
   - Se preservan todos los casos con RCP transtelefónica al unir datos SVB-SVA
   - **Regla de fusión**: Si un registro SVB o SVA tiene RCP transtelefónica=1, el resultado será 1, independientemente del valor en el otro registro (conserva TRUE ante cualquier combinación)
   - Si hay RCP transtelefónica, se asume también que:
     - `legos` = 1 (fue realizada por personal no sanitario)
     - `rcp_testigos` = 1 (hubo RCP por testigos)
   - Se identifican y reportan los casos de SVB con RCP transtelefónica que no pudieron fusionarse con SVA
   - **Verificación manual**: Todos los casos identificados como RCP transtelefónica fueron posteriormente revisados manualmente mediante el análisis de los textos de historia clínica, asegurando que la clasificación automática fuera correcta
   - Justificación: Garantizar que ningún caso de RCP transtelefónica se pierda en el proceso de limpieza, priorizando la sensibilidad del estudio y la precisión mediante doble verificación.

## 4. Reordenamiento y Estructura Final

### 4.1 Variables Finales (Orden de Columnas)

1. `n_informe`: Identificador único del caso
2. `fecha`: Fecha y hora del incidente
3. `edad`: Edad del paciente
4. `sexo`: Género del paciente
5. `rcp_transtelefonica`: ¿Se realizó RCP guiada por teléfono? (1=Sí, 0=No)
6. `rcp_testigos`: ¿Se realizó RCP por testigos antes de la llegada de la USVA? (1=Sí, 0=No)
7. `respondiente_rcp`: Tipo de persona que realizó la RCP (lego, sanitario, policia, bombero)
8. `desa_externo`: ¿Se utilizó desfibrilador externo? (1=Sí, 0=No)
9. `ritmo`: ¿El ritmo inicial era desfibrilable? (1=Sí, 0=No)
10. `tiempo_llegada_unidad`: Tiempo de llegada de la unidad en segundos
11. `tiempo_rcp`: Duración de la RCP en segundos
12. `rosc`: ¿Hubo recuperación de circulación espontánea? (1=Sí, 0=No)
13. `supervivencia_7dias`: ¿El paciente sobrevivió a los 7 días? (1=Sí, 0=No)
14. `cpc`: Criterio de perfusion cerebral (1-5, donde 1=sin secuelas, 5=muerte)

## 5. Limitaciones del Proceso de Limpieza

1. **Extracción de información textual**:
   - La identificación de outcomes se basa parcialmente en análisis de texto no estructurado
   - Palabras clave podrían no capturar todos los casos relevantes o generar falsos positivos

2. **Datos faltantes**:
   - Enfoque conservador que podría subestimar algunos outcomes positivos
   - Asignación de valores por defecto podría no reflejar la realidad clínica en todos los casos

3. **Integración SVB-SVA**:
   - La unión de datos se basa en coincidencia de fecha/hora entre los registros SVB y SVA
   - **Regla fundamental de fusión**: Si cualquier registro (SVB o SVA) tiene RCP transtelefónica=1, el registro fusionado tendrá RCP transtelefónica=1
   - Esta regla garantiza que no se pierda ningún caso positivo de RCP transtelefónica durante la fusión
   - Aquellos casos de RCP transtelefónica en SVB que no tienen coincidencia en SVA por fecha/hora no pueden ser incorporados

## 6. Estadísticas de Exclusión

### 6.1 Resumen Cuantitativo

El script genera un detallado reporte de exclusiones con las siguientes estadísticas principales:

- **Casos totales iniciales**: 603 casos
- **Excluidos por origen traumático**: 49 casos (8.1%)
- **Casos finales incluidos**: 554 casos (91.9%)

### 6.2 Impacto en Casos de RCP Transtelefónica

- **Casos iniciales con RCP transtelefónica**: 62 casos
- **Excluidos por origen traumático**: 5 casos (8.1%)
- **Casos finales incluidos**: 57 casos (91.9%)

### 6.3 Casos Traumáticos Excluidos con RCP Transtelefónica

Los siguientes 5 casos con RCP transtelefónica fueron excluidos por tener origen traumático:

1. **Caso #92369**: Excluido por mención a "caída" en columna 'evolución'
2. **Caso #133825**: Excluido por mención a "incendio" en columna 'consulta'
3. **Caso #118082**: Excluido por mención a "caída" en columna 'antecedentes'
4. **Caso #119769**: Excluido por mención a "trauma" en columna '7 días'
5. **Caso #13224**: Excluido por mención a "herido" en columna '7 días'

### 6.4 Análisis de Casos Conservados

El script genera estadísticas resumidas que muestran:
- Total de casos analizados
- Distribución de casos con/sin RCP transtelefónica
- ROSC por tipo de RCP (con/sin RCP transtelefónica)
- Supervivencia a 7 días por tipo de RCP

Estas estadísticas permiten evaluar el impacto del proceso de limpieza y exclusión en la población final de estudio.

## 7. Reproducibilidad del Proceso

El proceso completo está automatizado en el script `cleandata_simplified.py` y genera:
1. Dataset limpio en formato CSV (`cleaned_data.csv`)
2. Dataset limpio en formato Excel (`cleaned_data.xlsx`)
3. Estadísticas resumidas en la consola

Para reproducir la limpieza, ejecutar:
```bash
python data/2.Data_cleaning/cleandata_simplified.py
```

## 8. Conclusiones y Garantía de Calidad

El proceso de limpieza descrito anteriormente combina métodos automáticos (script de procesamiento) con verificación manual exhaustiva, proporcionando un nivel adicional de confianza en la calidad de los datos. La verificación manual fue especialmente importante para:

1. **Confirmar casos de RCP transtelefónica**: La identificación correcta de estos casos es fundamental para el estudio
2. **Validar criterios de exclusión**: Asegurar que solo se excluyeron casos que cumplían estrictamente los criterios
3. **Revisar outcomes clave**: Los resultados de ROSC, supervivencia y CPC fueron individualmente verificados

Esta combinación de procesamiento automatizado y revisión manual humana proporciona la máxima garantía de calidad para los datos utilizados en los análisis estadísticos posteriores.